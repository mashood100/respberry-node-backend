<style>
    .mobile-header {
        background: linear-gradient(45deg, #4CAF50, #45a049);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .mobile-header h2 {
        font-size: 1.5em;
        margin-bottom: 5px;
    }
    
    .mobile-header p {
        font-size: 0.9em;
        opacity: 0.9;
    }
    
    .connection-status {
        background: rgba(76, 175, 80, 0.1);
        border: 2px solid #4CAF50;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
        color: #4CAF50;
        font-weight: bold;
    }
    
    .connection-status.connected {
        background: rgba(76, 175, 80, 0.2);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .mobile-content {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    
    .mobile-content-text {
        font-size: 20px;
        line-height: 1.6;
        margin-bottom: 15px;
        word-wrap: break-word;
    }
    
    .mobile-content-image {
        max-width: 100%;
        max-height: 250px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .sync-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #4CAF50;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .sync-indicator.show {
        opacity: 1;
    }
    
    .offline-message {
        background: rgba(244, 67, 54, 0.1);
        border: 2px solid #f44336;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
        color: #f44336;
        font-weight: bold;
    }
    
    .reconnect-btn {
        background: #ff9800;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
    }
    
    .reconnect-btn:hover {
        background: #f57c00;
    }
</style>

<div class="mobile-header">
    <h2>üì± Connected to Game Hub</h2>
    <p>You're now synchronized with the Raspberry Pi display</p>
</div>

<div class="connection-status connected" id="connection-status">
    ‚úÖ Connected and synchronized
</div>

<div class="mobile-content" id="mobile-content" {{#if activeContent}}style="background-color: {{activeContent.backgroundColor}}"{{/if}}>
    {{#if activeContent}}
        <div class="mobile-content-text" id="mobile-content-text" 
             style="color: {{activeContent.textColor}}; font-size: {{activeContent.fontSize}}px;">
            {{{activeContent.textContent}}}
        </div>
        {{#if activeContent.imageUrl}}
            <img src="{{activeContent.imageUrl}}" alt="Content Image" class="mobile-content-image" id="mobile-content-image">
        {{/if}}
    {{else}}
        <div class="mobile-content-text loading">
            Waiting for content from the Pi...
        </div>
    {{/if}}
</div>

<div style="background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 15px; text-align: center; margin-top: 20px;">
    <p style="color: rgba(255, 255, 255, 0.8); font-size: 14px;">
        üîÑ Content updates in real-time<br>
        üìä Device ID: {{device.sessionId}}
    </p>
</div>

<div class="sync-indicator" id="sync-indicator">
    Syncing...
</div>

<script>
    let isOnline = true;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    
    // Initialize Socket.IO connection with better error handling
    const socket = io({
        transports: ['websocket', 'polling'],
        upgrade: true,
        rememberUpgrade: true
    });
    
    // Connection event handlers
    socket.on('connect', function() {
        console.log('‚úÖ WebSocket connection established, ID:', socket.id);
        isOnline = true;
        reconnectAttempts = 0;
        updateConnectionStatus(true);
        showSyncIndicator();
        
        // Request current active content on connect
        socket.emit('get_active_content');
    });
    
    socket.on('content_update', function(data) {
        console.log('üì± Received content update:', data);
        updateContent(data);
        showSyncIndicator();
    });
    
    socket.on('disconnect', function(reason) {
        console.log('‚ùå WebSocket connection closed, reason:', reason);
        isOnline = false;
        updateConnectionStatus(false);
        
        // Attempt to reconnect only if not intentionally disconnected
        if (reason !== 'io client disconnect' && reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`üîÑ Reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
            setTimeout(() => {
                socket.connect();
            }, 2000 * reconnectAttempts); // Exponential backoff
        }
    });
    
    socket.on('connect_error', function(error) {
        console.error('‚ùå Connection error:', error);
        updateConnectionStatus(false);
    });
    
    // Enhanced content update function
    function updateContent(content) {
        console.log('üîÑ Updating mobile content with:', content);
        
        const mobileContent = document.getElementById('mobile-content');
        if (!mobileContent) {
            console.error('‚ùå Mobile content container not found');
            return;
        }
        
        // Clear existing content
        mobileContent.innerHTML = '';
        
        // Apply background color
        if (content.background_color) {
            mobileContent.style.backgroundColor = content.background_color;
            console.log('üé® Applied background color:', content.background_color);
        }
        
        // Add text content
        if (content.text_content) {
            const textElement = document.createElement('div');
            textElement.className = 'mobile-content-text';
            textElement.id = 'mobile-content-text';
            textElement.innerHTML = content.text_content;
            
            if (content.text_color) {
                textElement.style.color = content.text_color;
            }
            if (content.font_size) {
                textElement.style.fontSize = content.font_size + 'px';
            }
            
            mobileContent.appendChild(textElement);
            console.log('üìù Added text content:', content.text_content.substring(0, 50));
        }
        
        // Add image content
        if (content.image_url) {
            const imageElement = document.createElement('img');
            imageElement.className = 'mobile-content-image';
            imageElement.id = 'mobile-content-image';
            imageElement.src = content.image_url;
            imageElement.alt = 'Content Image';
            imageElement.style.display = 'block';
            
            // Handle image load errors
            imageElement.onerror = function() {
                console.error('‚ùå Failed to load image:', content.image_url);
                this.style.display = 'none';
            };
            
            imageElement.onload = function() {
                console.log('üñºÔ∏è Image loaded successfully:', content.image_url);
            };
            
            mobileContent.appendChild(imageElement);
        }
        
        // Add smooth transition effect
        mobileContent.style.transition = 'all 0.3s ease';
        mobileContent.style.transform = 'scale(0.95)';
        mobileContent.style.opacity = '0.8';
        
        setTimeout(() => {
            mobileContent.style.transform = 'scale(1)';
            mobileContent.style.opacity = '1';
        }, 100);
        
        console.log('‚úÖ Content update completed');
    }
    
    function updateConnectionStatus(connected) {
        const statusElement = document.getElementById('connection-status');
        if (!statusElement) return;
        
        if (connected) {
            statusElement.className = 'connection-status connected';
            statusElement.innerHTML = '‚úÖ Connected and synchronized';
            statusElement.style.borderColor = '#4CAF50';
            statusElement.style.color = '#4CAF50';
            
            // Hide offline message if it exists
            const offlineMessage = document.getElementById('offline-message');
            if (offlineMessage) {
                offlineMessage.remove();
            }
        } else {
            statusElement.className = 'connection-status';
            statusElement.innerHTML = '‚ùå Connection lost - Trying to reconnect...';
            statusElement.style.borderColor = '#f44336';
            statusElement.style.color = '#f44336';
            
            // Show offline message
            if (!document.getElementById('offline-message')) {
                const offlineMessage = document.createElement('div');
                offlineMessage.id = 'offline-message';
                offlineMessage.className = 'offline-message';
                offlineMessage.innerHTML = `
                    ‚ö†Ô∏è Lost connection to the Game Hub<br>
                    Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})
                    <br>
                    <button class="reconnect-btn" onclick="forceReconnect()">
                        Force Reconnect
                    </button>
                    <button class="reconnect-btn" onclick="location.reload()">
                        Reload Page
                    </button>
                `;
                statusElement.parentNode.insertBefore(offlineMessage, statusElement.nextSibling);
            }
        }
    }
    
    function showSyncIndicator() {
        const indicator = document.getElementById('sync-indicator');
        if (indicator) {
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1500);
        }
    }
    
    function forceReconnect() {
        console.log('üîÑ Force reconnecting...');
        reconnectAttempts = 0;
        socket.disconnect();
        setTimeout(() => {
            socket.connect();
        }, 1000);
    }
    
    // Send heartbeat to keep connection alive and track device
    setInterval(() => {
        if (socket.connected) {
            socket.emit('device_heartbeat', {
                'session_id': '{{device.sessionId}}',
                'timestamp': new Date().toISOString(),
                'device_type': 'mobile'
            });
            console.log('üíì Heartbeat sent');
        } else {
            console.log('üíî Heartbeat skipped - not connected');
        }
    }, 30000); // Every 30 seconds
    
    // Enhanced page visibility handling
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('üì± Page is now hidden');
        } else {
            console.log('üì± Page is now visible');
            if (!socket.connected) {
                console.log('üîÑ Page visible but not connected, attempting reconnect...');
                socket.connect();
            } else {
                // Request fresh content when page becomes visible
                socket.emit('get_active_content');
            }
        }
    });
    
    // Request content update when page loads
    window.addEventListener('load', () => {
        console.log('üì± Mobile page loaded, requesting active content...');
        if (socket.connected) {
            socket.emit('get_active_content');
        }
    });
    
    // Debug connection status every 10 seconds
    setInterval(() => {
        console.log('üîç Connection status:', {
            connected: socket.connected,
            id: socket.id,
            isOnline: isOnline,
            reconnectAttempts: reconnectAttempts
        });
    }, 10000);
</script> 